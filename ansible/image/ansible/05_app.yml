---
- hosts: guests:extras
  become: yes
  gather_facts: no
  vars:
    app_dir: "/home/isucon/private_isu"
    repo_root: "{{ playbook_dir }}/../../../"
  tasks:
    - name: mkdir backup
      file: path=/home/isucon/backup/ state=directory
    - name: Ensure application directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: isucon
        group: isucon
        mode: "0755"
    - name: Sync webapp to server
      ansible.builtin.synchronize:
        src: "{{ repo_root }}/webapp/"
        dest: "{{ app_dir }}/webapp/"
        delete: yes
        rsync_opts:
          - "--exclude=mysql-data"
    - name: Sync benchmarker to server
      ansible.builtin.synchronize:
        src: "{{ repo_root }}/benchmarker/"
        dest: "{{ app_dir }}/benchmarker/"
        delete: yes
      when: allinone is defined and allinone
    - name: Fix ownership
      file:
        path: "{{ app_dir }}"
        owner: isucon
        group: isucon
        recurse: yes
