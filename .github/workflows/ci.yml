name: CI

on:
  pull_request:
    paths:
      - "webapp/**"
      - "benchmarker/**"
      - ".github/workflows/ci.yml"
      - "Makefile"
      - "webapp/compose.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Initialize the project
        run: make init

      - name: Start the server
        run: |
          cd webapp
          docker compose up --build -d

      - name: Build the benchmark
        run: |
          cd benchmarker
          docker build -t private-isu-benchmarker .

      - name: Wait for data initialization to complete
        run: |
          cd webapp
          until docker compose exec -T mysql mysql -uroot -proot -e "SELECT 1 FROM posts LIMIT 1;" isuconp; do
            echo "Waiting for database initialization..."
            sleep 10
          done
          until docker compose exec -T mysql mysql -uroot -proot -e "SELECT 1 FROM users LIMIT 1;" isuconp; do
            echo "Waiting for database initialization..."
            sleep 10
          done
          until docker compose exec -T mysql mysql -uroot -proot -e "SELECT 1 FROM comments LIMIT 1;" isuconp; do
            echo "Waiting for database initialization..."
            sleep 10
          done

      - name: Run the benchmark
        id: benchmark
        continue-on-error: true
        run: |
          cd benchmarker
          docker run \
            --network host \
            --add-host host.docker.internal:host-gateway \
            -i private-isu-benchmarker \
            /bin/benchmarker \
            -t http://host.docker.internal \
            -u /opt/userdata \
          | tee benchmark_output.json

      - name: Show logs
        run: |
          cd webapp
          docker compose logs

      - name: Check benchmark result
        run: |
          cd benchmarker
          if [ ! -f benchmark_output.json ]; then
            echo "benchmark_output.json not found"
            exit 1
          fi
          if ! jq -e '.pass == true' benchmark_output.json > /dev/null; then
            echo "Benchmark failed: pass is not true"
            exit 1
          fi

      - name: Fail if benchmark failed
        if: steps.benchmark.outcome == 'failure'
        run: |
          echo "Benchmark failed"
          exit 1
